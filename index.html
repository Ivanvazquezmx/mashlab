<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>MashLab Studio 1.2 - Pure Tone</title>

<style>
  :root {
    --bg-main: #000000;
    --bg-card: rgba(15, 20, 30, 0.95);
    --border: rgba(255, 255, 255, 0.08);
    --text: #f8fafc;
    --sub: #64748b;
    --ok: #00ff88;    
    --warn: #ffcc00;  
    --pitch: #22d3ee; 
    --blue: #3b82f6; 
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  
  body {
    margin: 0; padding: 0; min-height: 100vh;
    background: var(--bg-main);
    color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
    overflow-x: hidden; padding-bottom: env(safe-area-inset-bottom);
  }

  .container { max-width: 900px; margin: 0 auto; padding: 12px 12px 100px; }

  .topbar {
    position: sticky; top: 0; z-index: 1000;
    background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border-bottom: 1px solid var(--border);
  }
  .topbar-inner { display: flex; align-items: center; justify-content: space-between; height: 64px; padding: 0 20px; }
  .brand { font-weight: 900; font-size: 20px; letter-spacing: -1px; }

  .panel { 
    background: var(--bg-card); border: 1px solid var(--border); 
    border-radius: 28px; padding: 24px; margin-bottom: 20px; 
  }
  .song-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media(max-width: 700px) { .song-grid { grid-template-columns: 1fr; } }
  h3 { margin: 0 0 12px 0; font-size: 10px; color: var(--sub); text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }

  #progressContainer {
    display: none; margin-bottom: 15px; background: rgba(255,255,255,0.05);
    border-radius: 14px; padding: 15px; border: 1px solid var(--border);
  }
  .progress-bar-bg { background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; margin-top: 10px; overflow: hidden; }
  #progressBar { background: var(--ok); width: 0%; height: 100%; transition: width 0.3s; }

  .drop-zone {
    border: 1px dashed rgba(255,255,255,0.1); border-radius: 16px; padding: 20px;
    text-align: center; cursor: pointer; transition: 0.3s; 
    background: rgba(255,255,255,0.02); margin-bottom: 15px;
  }
  .drop-zone:hover { border-color: var(--ok); background: rgba(0, 255, 136, 0.05); }

  .song-item {
    background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
    border-radius: 20px; padding: 12px 16px; display: grid; grid-template-columns: 1fr auto auto;
    gap: 8px; align-items: center; margin-bottom: 8px;
  }
  .song-item.is-guide { border-color: rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.08); }

  .input, .select { background: transparent; border: none; color: #fff; padding: 4px; font-size: 13px; font-weight: 700; cursor: pointer; }
  .input-title { border-bottom: 1px solid transparent; width: 100%; }
  .input-title:focus { border-bottom-color: var(--pitch); background: rgba(255,255,255,0.05); }

  .wheel-box {
    background: #000; border-radius: 40px; padding: 40px 10px;
    border: 1px solid rgba(255,255,255,0.02); margin-bottom: 30px;
  }
  .wheel-inner { width: 100%; max-width: 500px; aspect-ratio: 1/1; position: relative; margin: 0 auto; }
  svg.camelot-wheel { width: 100%; height: 100%; transform: rotate(-15deg); overflow: visible; }
  
  .segment { stroke: #000; stroke-width: 0.5px; transition: 0.3s ease; cursor: pointer; }
  .segment.active-key { stroke: #fff; stroke-width: 1.5px; filter: drop-shadow(0 0 6px rgba(255,255,255,0.6)); }
  
  .glow-ok { filter: drop-shadow(0 0 8px var(--ok)); stroke: var(--ok); stroke-width: 1px; }
  .glow-warn { filter: drop-shadow(0 0 8px var(--warn)); stroke: var(--warn); stroke-width: 1px; }
  .glow-pitch { filter: drop-shadow(0 0 8px var(--pitch)); stroke: var(--pitch); stroke-width: 1px; }

  .label-cam { font-weight: 900; font-size: 14px; fill: #fff; pointer-events: none; dominant-baseline: middle; }
  .label-ang { font-size: 9px; opacity: 0.5; fill: #fff; pointer-events: none; dominant-baseline: middle; }

  .analysis-card { background: var(--bg-card); border-radius: 28px; padding: 25px; margin-bottom: 20px; border: 1px solid var(--border); }
  .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-top: 15px; }
  
  .opt-box {
    background: rgba(255, 255, 255, 0.02); padding: 16px; border-radius: 20px; 
    border: 1.5px solid rgba(255,255,255,0.05); text-align: center; cursor: pointer; transition: 0.3s;
    font-weight: 800; font-size: 11px;
  }
  .opt-box.type-match { border-color: rgba(0, 255, 136, 0.2); color: rgba(0, 255, 136, 0.6); }
  .opt-box.type-energy { border-color: rgba(255, 204, 0, 0.2); color: rgba(255, 204, 0, 0.6); }
  .opt-box.type-pitchpro { border-color: rgba(34, 211, 238, 0.2); color: rgba(34, 211, 238, 0.6); }

  .opt-box.selected.type-match { background: rgba(0, 255, 136, 0.15); border-color: var(--ok); color: #fff; box-shadow: 0 0 15px rgba(0, 255, 136, 0.3); transform: translateY(-2px); }
  .opt-box.selected.type-energy { background: rgba(255, 204, 0, 0.15); border-color: var(--warn); color: #fff; box-shadow: 0 0 15px rgba(255, 204, 0, 0.3); transform: translateY(-2px); }
  .opt-box.selected.type-pitchpro { background: rgba(34, 211, 238, 0.15); border-color: var(--pitch); color: #fff; box-shadow: 0 0 15px rgba(34, 211, 238, 0.3); transform: translateY(-2px); }

  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 10px 18px; border-radius: 14px; border: 1px solid var(--border);
    background: rgba(255, 255, 255, 0.05); color: var(--text); cursor: pointer; font-weight: 700; font-size: 11px;
  }
  .btn.active { background: #fff; color: #000; border-color: #fff; }

  .btn-add { width: 100%; border-style: dashed; opacity: 0.5; margin-top: 5px; background: transparent; }
  .btn-add:hover { opacity: 1; border-color: var(--ok); color: var(--ok); }

  .disclaimer-box {
    background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border);
    border-radius: 18px; padding: 14px; margin-top: 10px; text-align: center;
    font-size: 10.5px; color: var(--sub); line-height: 1.4;
  }
  .disclaimer-box b { color: var(--pitch); font-weight: 900; }

  .donation-banner {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid var(--border); border-radius: 24px; padding: 20px; margin: 20px 0;
    display: flex; align-items: center; justify-content: space-between; gap: 15px;
    backdrop-filter: blur(10px);
  }

  .footer { margin-top: 40px; text-align: center; border-top: 1px solid var(--border); padding: 60px 20px 80px; }
  .footer-brand { 
    font-size: 13px; color: #fff; letter-spacing: 5px; font-weight: 900; 
    text-transform: uppercase; margin-bottom: 20px; opacity: 0.9;
  }
  .social-links { display: flex; justify-content: center; gap: 20px; }
  .social-links a { color: var(--sub); text-decoration: none; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
  
  .marker-text { font-size: 9px; font-weight: 900; fill: #000; pointer-events: none; dominant-baseline: middle; }
</style>
</head>
<body>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand"><span style="color:var(--ok)">MASH</span>LAB <span style="font-weight:200; opacity:0.4">Studio 1.2</span></div>
      <div style="display:flex; gap:6px; background:rgba(255,255,255,0.04); padding:4px; border-radius:18px; border:1px solid var(--border)">
        <button id="modeVoz" class="btn active" onclick="setMode('voz')">Voz Manda</button>
        <button id="modeInst" class="btn" onclick="setMode('inst')">Base Manda</button>
        <button class="btn" onclick="resetState()" style="border-color: var(--blue); color: var(--blue)">Reset</button>
      </div>
    </div>
  </div>

  <div class="container">
    
    <div id="progressContainer">
      <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:800">
        <span id="progressText">Analizando Tracks...</span>
        <button onclick="cancelQueue()" style="background:transparent; border:none; color:var(--sub); font-size:10px; cursor:pointer">CANCELAR</button>
      </div>
      <div class="progress-bar-bg"><div id="progressBar"></div></div>
    </div>

    <!-- KO-FI WIDGET RESTAURADO -->
    <div class="donation-banner">
      <div style="display: flex; align-items: center; gap: 20px;">
        <span style="font-size: 32px;">‚òï</span>
        <div style="text-align: left;">
          <div style="font-weight: 800; font-size: 16px; color: #fff;">MashLab Studio 1.2</div>
          <div style="font-size: 13px; color: var(--sub); max-width: 450px; line-height: 1.4;">
            Bro, si esta aplicaci√≥n te est√° ayudando, ap√≥yame para seguir desarroll√°ndola gratis.
          </div>
        </div>
      </div>
      <div id="kofi-widget-container">
        <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
        <script type='text/javascript'>
          if (navigator.onLine) {
            kofiwidget2.init('Apoyar', '#00ff88', 'U7U319RGKF');
            kofiwidget2.draw();
          }
        </script>
      </div>
    </div>

    <div class="panel">
      <div class="song-grid">
        <div id="colVoz">
          <h3>üé§ Vocales Gu√≠a</h3>
          <div class="drop-zone" onclick="document.getElementById('in_voz').click()">
            <span style="display:block; font-size:10px; font-weight:900; color:var(--sub); text-transform: uppercase;">Sueltalo aqu√≠ para detecci√≥n</span>
            <input type="file" id="in_voz" accept="audio/*" hidden>
          </div>
          <div id="listV"></div>
          <button class="btn btn-add" onclick="addSongManual('voz')">‚ûï A√±adir Voz Manual</button>
        </div>
        <div id="colInst">
          <h3>ü•Å Bases Beats</h3>
          <div class="drop-zone" onclick="document.getElementById('in_inst').click()">
            <span style="display:block; font-size:10px; font-weight:900; color:var(--sub); text-transform: uppercase;">Sueltalo aqu√≠ para detecci√≥n</span>
            <input type="file" id="in_inst" accept="audio/*" hidden>
          </div>
          <div id="listI"></div>
          <button class="btn btn-add" onclick="addSongManual('inst')">‚ûï A√±adir Base Manual</button>
        </div>
      </div>
      
      <div class="disclaimer-box">
        <b>Fase Beta:</b> Detecci√≥n tonal comparada con Rekordbox y Serato. Al igual que otras IAs, puede cometer errores; verifica tus resultados y conf√≠a en tu o√≠do.
      </div>
    </div>

    <div class="wheel-box">
      <div style="text-align:center; margin-bottom:30px">
        <div style="display:inline-flex; align-items:center; gap:12px; background:rgba(255,255,255,0.02); padding:10px 25px; border-radius:100px; border:1px solid var(--border)">
           <span style="font-size:9px; color:var(--sub); font-weight:900; letter-spacing:1px">KEY GU√çA</span>
           <span id="guideKeyLabel" style="color:var(--ok); font-size:22px; font-weight:900; letter-spacing:0.5px">--</span>
        </div>
      </div>
      <div class="wheel-inner"><div id="wheelTarget" style="width:100%; height:100%;"></div></div>
    </div>

    <div id="analysisContainer"></div>

    <footer class="footer">
      <div class="footer-brand">MashLab Studio</div>
      <div class="social-links">
        <a href="https://www.patreon.com/c/Ivanvazquezmx" target="_blank">Patreon</a>
        <a href="https://linktr.ee/ivanvazquezmusic" target="_blank">Linktree</a>
        <a href="https://www.instagram.com/ivanvazquezmx/" target="_blank">Instagram</a>
      </div>
    </footer>
  </div>

<script>
// ==========================================
// ENGINE (TONALITY ONLY)
// ==========================================
const NOTE_NAMES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const DATA = {"1A":"G#m","2A":"Ebm","3A":"Bbm","4A":"Fm","5A":"Cm","6A":"Gm","7A":"Dm","8A":"Am","9A":"Em","10A":"Bm","11A":"F#m","12A":"Dbm","1B":"B","2B":"F#","3B":"Db","4B":"Ab","5B":"Eb","6B":"Bb","7B":"F","8B":"C","9B":"G","10B":"D","11B":"A","12B":"E"};
const PC = {"1A":8,"2A":3,"3A":10,"4A":5,"5A":0,"6A":7,"7A":2,"8A":9,"9A":4,"10A":11,"11A":6,"12A":1,"1B":11,"2B":6,"3B":1,"4B":8,"5B":3,"6B":10,"7B":5,"8B":0,"9B":7,"10B":2,"11B":9,"12B":4};
const CAMELOT_MAP = {"C":"8B","Cm":"5A","C#":"9B","C#m":"6A","D":"10B","Dm":"7A","D#":"11B","D#m":"8A","E":"12B","Em":"9A","F":"7B","Fm":"4A","F#":"2B","F#m":"11A","G":"9B","Gm":"6A","G#":"4B","G#m":"1A","A":"11B","Am":"8A","A#":"6B","A#m":"3A","B":"1B","Bm":"10A","Db":"3B","Dbm":"12A","Eb":"5B","Ebm":"2A","Bb":"6B","Bbm":"3A"};

function mean(arr){ return arr.reduce((a,b)=>a+b,0)/(arr.length||1); }
function std(arr){
  const m = mean(arr);
  const v = mean(arr.map(x => (x-m)*(x-m)));
  return Math.sqrt(v);
}
function normalizeVec(v){
  const m = mean(v);
  const s = std(v) || 1;
  return v.map(x => (x-m)/s);
}
function rotate12(v, r){
  const out = new Array(12);
  for(let i=0;i<12;i++) out[(i+r)%12] = v[i];
  return out;
}
function dot(a,b){ let s=0; for(let i=0;i<a.length;i++) s += a[i]*b[i]; return s; }

async function analyzeAudioData(file) {
  const ac = new (window.AudioContext || window.webkitAudioContext)();
  try {
    const rawBuffer = await ac.decodeAudioData(await file.arrayBuffer());
    const sr = rawBuffer.sampleRate, duration = rawBuffer.duration;
    let startSec = duration * 0.15, scanLenSec = duration * 0.70;
    if (duration < 2) { startSec = 0; scanLenSec = duration; }
    const startByte = Math.max(0, Math.floor(startSec * sr)), lenByte = Math.min(rawBuffer.length - startByte, Math.floor(scanLenSec * sr));
    const mono = new Float32Array(lenByte), channels = rawBuffer.numberOfChannels;
    for(let c=0; c<channels; c++){ const ch = rawBuffer.getChannelData(c); for(let i=0; i<lenByte; i++) mono[i] += ch[startByte+i] / channels; }
    
    const fSize = 8192, hop = 8192, nF = Math.floor((mono.length - fSize) / hop), chroma = new Float64Array(12);
    if (nF > 0) {
      for(let f=0; f < nF; f++){
        const st = f * hop, frame = new Float32Array(fSize);
        for(let i=0;i<fSize;i++) frame[i] = mono[st+i] * (0.5 - 0.5*Math.cos(2*Math.PI*i/(fSize-1)));
        const local = new Float64Array(12);
        for(let m=40; m<=84; m++) { const frq = 440 * Math.pow(2,(m-69)/12), pc = m % 12; let s0=0, s1=0, s2=0, w=2*Math.PI*frq/sr, c=2*Math.cos(w); for(let i=0;i<fSize;i++){ s0=frame[i]+c*s1-s2; s2=s1; s1=s0; } local[pc] += Math.log1p(Math.max(0, s1*s1+s2*s2-c*s1*s2)); }
        const sum = local.reduce((a,b)=>a+b,0) || 1;
        for(let i=0;i<12;i++) chroma[i] += local[i]/sum;
      }
    }
    const cN = normalizeVec(Array.from(chroma)), majT = normalizeVec([6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88]), minT = normalizeVec([6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17]);
    let bS = -Infinity, bT = 0, bM = "major";
    for(let t=0; t<12; t++){ const sMaj = dot(cN, rotate12(majT, t)), sMin = dot(cN, rotate12(minT, t)) * 1.15; if(sMaj > bS){ bS = sMaj; bT = t; bM = "major"; } if(sMin > bS){ bS = sMin; bT = t; bM = "minor"; } }
    return { key: CAMELOT_MAP[NOTE_NAMES[bT] + (bM==="minor"?"m":"")] || "8A" };
  } catch(e) { throw e; }
  finally { await ac.close(); }
}

let queue = [];
let isQueueRunning = false;
let state = JSON.parse(localStorage.getItem('mashlab_state_v12_pure_multi')) || {
  mode: 'voz',
  selectedRel: 'Exacta', 
  voices: [{id: 1, title: 'Vocal Gu√≠a', key: '12A'}],
  insts: [{id: 101, title: 'Base Beat', key: '8A'}]
};

function saveState() { localStorage.setItem('mashlab_state_v12_pure_multi', JSON.stringify(state)); }
function resetState() { localStorage.removeItem('mashlab_state_v12_pure_multi'); location.reload(); }

async function processQueue() {
  if (isQueueRunning || queue.length === 0) return;
  isQueueRunning = true;
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');
  const txt = document.getElementById('progressText');
  container.style.display = 'block';
  while(queue.length > 0) {
    const job = queue.shift();
    txt.textContent = `Analizando Tono: ${job.file.name.substring(0,20)}...`;
    bar.style.width = `50%`;
    try {
      const res = await analyzeAudioData(job.file);
      const arr = job.role === 'voz' ? state.voices : state.insts;
      // Detecci√≥n autom√°tica solo sobreescribe el primero si es el inicial, 
      // o siempre el primero para mantener la l√≥gica de "Gu√≠a"
      arr[0].title = job.file.name.split('.')[0].substring(0, 25);
      arr[0].key = res.key;
      render();
    } catch(e) { console.error("Error analizando track", e); }
    bar.style.width = `100%`;
    await new Promise(r => setTimeout(r, 100));
  }
  isQueueRunning = false;
  container.style.display = 'none';
  saveState();
}

function cancelQueue() { queue = []; isQueueRunning = false; document.getElementById('progressContainer').style.display = 'none'; }
function handleFiles(files, role) { if(!files.length) return; for(let file of files) { queue.push({file, role}); } processQueue(); }

function addSongManual(role) {
    const id = Date.now();
    const newSong = { id, title: role === 'voz' ? `Vocal ${state.voices.length + 1}` : `Base ${state.insts.length + 1}`, key: '8A' };
    if (role === 'voz') state.voices.push(newSong); else state.insts.push(newSong);
    render();
    saveState();
}

function deleteSong(role, id) {
    const arr = role === 'voz' ? state.voices : state.insts;
    if (arr.length <= 1) return; // Mantener siempre al menos uno
    if (role === 'voz') state.voices = state.voices.filter(s => s.id !== id);
    else state.insts = state.insts.filter(s => s.id !== id);
    render();
    saveState();
}

function getTargetKey(guide, type) {
  const n = parseInt(guide), m = guide.slice(-1);
  if (type === 'Exacta') return guide;
  if (type === 'Relativa') return `${n}${m === 'A' ? 'B' : 'A'}`;
  if (type === 'Subida') return `${n === 12 ? 1 : n + 1}${m}`;
  if (type === 'Sutil') return `${n === 1 ? 12 : n - 1}${m}`;
  if (type === 'Energ√≠a') return `${n+2>12 ? (n+2)-12 : n+2}${m}`;
  if (type === 'PitchPro') {
    let p = null, mi = null;
    for (let k of Object.keys(DATA)) { if (k === guide || k.slice(-1) !== m) continue; const s = getShift(guide, k); if (s === 1) p = k; if (s === -1) mi = k; }
    return p || mi || guide;
  }
  return guide;
}
function getShift(f, t) { let d = (PC[t]-PC[f]+12)%12; return d>6?d-12:d; }

function updateField(role, id, field, value) { 
  const arr = role === 'voz' ? state.voices : state.insts; 
  const s = arr.find(x => x.id == id); 
  if (s) { s[field] = value; render(); saveState(); } 
}

function setMode(m) { state.mode=m; document.getElementById('modeVoz').classList.toggle('active',m==='voz'); document.getElementById('modeInst').classList.toggle('active',m==='inst'); render(); saveState(); }

function render() {
  const list = state.mode === 'voz' ? state.voices : state.insts;
  const guideKey = list.length ? list[0].key : "1A";
  document.getElementById('guideKeyLabel').textContent = `${guideKey} (${DATA[guideKey]})`;
  renderFileList('listV', state.voices, 'voz');
  renderFileList('listI', state.insts, 'inst');
  renderAnalysis(guideKey);
  drawWheel(guideKey);
}

function renderFileList(id, arr, role) {
  const container = document.getElementById(id); container.innerHTML = "";
  arr.forEach((s, idx) => {
    const isG = (state.mode === role && idx === 0);
    const div = document.createElement('div'); div.className = `song-item ${isG ? 'is-guide' : ''}`;
    div.innerHTML = `
      <div style="overflow:hidden;">
        <input type="text" class="input input-title" value="${s.title}" oninput="updateField('${role}', '${s.id}', 'title', this.value)">
      </div>
      <div style="display:flex; align-items:center; gap:6px">
        <select class="select" onchange="updateField('${role}', '${s.id}', 'key', this.value)">
          ${Object.keys(DATA).map(k => `<option value="${k}" ${k===s.key?'selected':''}>${k}</option>`).join('')}
        </select>
        <span style="font-size:10px; color:var(--pitch); font-weight:800; min-width:30px">${DATA[s.key]}</span>
      </div>
      ${arr.length > 1 ? `<button style="background:none; border:none; color:rgba(255,255,255,0.2); cursor:pointer; padding:0 5px" onclick="deleteSong('${role}', ${s.id})">‚úï</button>` : '<span></span>'}
    `;
    container.appendChild(div);
  });
}

function renderAnalysis(guideKey) {
  const container = document.getElementById('analysisContainer');
  const targets = state.mode === 'voz' ? state.insts : state.voices;
  if (!targets.length) { container.innerHTML = ""; return; }
  container.innerHTML = targets.map((song, idx) => {
    const tk = getTargetKey(guideKey, state.selectedRel), s = getShift(song.key, tk);
    const rolePrefix = state.mode === 'voz' ? 'B' : 'V';
    return `<div class="analysis-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
        <div>
          <div style="font-weight:900; font-size:14px">${rolePrefix}${idx+1}: ${song.title}</div>
          <div style="font-size:11px; opacity:0.5">${song.key} <span style="color:var(--pitch); font-weight:800; margin-left:4px">${DATA[song.key]}</span></div>
        </div>
        <div style="font-size:28px; font-weight:900; color:var(--ok)">${s>=0?'+':''}${s} <span style="font-size:12px; opacity:0.3">st</span></div>
      </div>
      <div class="options-grid">
        ${['Exacta','Relativa','Subida','Sutil','Energ√≠a','PitchPro'].map(type => { 
          const k = getTargetKey(guideKey, type), sh = getShift(song.key, k); 
          const colorCat = ['Exacta','Relativa','Subida','Sutil'].includes(type) ? 'match' : (type==='Energ√≠a' ? 'energy' : 'pitchpro');
          return `<div class="opt-box type-${colorCat} ${state.selectedRel===type?'selected':''}" onclick="state.selectedRel='${type}'; render(); saveState();">
            <div style="font-size:7px; opacity:0.6; margin-bottom:2px">${type.toUpperCase()}</div>
            <div style="font-size:13px; font-weight:900">${k} (${DATA[k]})</div>
            <div style="font-size:11px; margin-top:4px; color:var(--ok)">${sh>=0?'+':''}${sh}st</div>
          </div>`; 
        }).join('')}
      </div>
    </div>`;
  }).join('');
}

function drawWheel(guideKey) {
  const target = document.getElementById('wheelTarget');
  const size = 500, cx = 250, cy = 250, rO = 240, rM = 165, rI = 90;
  let html = `<svg viewBox="0 0 ${size} ${size}" class="camelot-wheel">`;
  for(let i=1; i<=12; i++) { 
    const centerDeg = (i * 30) - 105, startDeg = centerDeg - 15, endDeg = centerDeg + 15; 
    html += drawSeg(cx, cy, rM, rO, startDeg, endDeg, `${i}B`, guideKey); 
    html += drawSeg(cx, cy, rI, rM, startDeg, endDeg, `${i}A`, guideKey); 
  }
  target.innerHTML = html + `</svg>`;
}

function drawSeg(cx, cy, rin, rout, s, e, key, guide) {
  const rad = Math.PI / 180, mid = (s + e) / 2, isA = key === guide;
  const tkList = ['Exacta','Relativa','Subida','Sutil','Energ√≠a','PitchPro'], targetKeys = tkList.map(t => getTargetKey(guide, t)), isGhost = targetKeys.includes(key), curTarget = getTargetKey(guide, state.selectedRel), isGlow = (key === curTarget && !isA);
  const x1 = cx + rout * Math.cos(s * rad), y1 = cy + rout * Math.sin(s * rad), x2 = cx + rout * Math.cos(e * rad), y2 = cy + rout * Math.sin(e * rad), x3 = cx + rin * Math.cos(e * rad), y3 = cy + rin * Math.sin(e * rad), x4 = cx + rin * Math.cos(s * rad), y4 = cy + rin * Math.sin(s * rad);
  
  let fill = "rgba(255,255,255,0.01)";
  let glowClass = "";
  if (isA) fill = "#fff"; 
  else if (isGlow) {
    if (state.selectedRel === 'Energ√≠a') { fill = "rgba(255, 204, 0, 0.7)"; glowClass = "glow-warn"; }
    else if (state.selectedRel === 'PitchPro') { fill = "rgba(34, 211, 238, 0.7)"; glowClass = "glow-pitch"; }
    else { fill = "rgba(0, 255, 136, 0.7)"; glowClass = "glow-ok"; }
  } else if (isGhost) {
    if (key === getTargetKey(guide, 'Energ√≠a')) fill = "rgba(255, 204, 0, 0.1)";
    else if (key === getTargetKey(guide, 'PitchPro')) fill = "rgba(34, 211, 238, 0.1)";
    else fill = "rgba(0, 255, 136, 0.1)";
  }

  const tx = cx + ((rin + rout) / 2) * Math.cos(mid * rad), ty = cy + ((rin + rout) / 2) * Math.sin(mid * rad);
  
  // DIBUJO DE MARCADORES MULTIPLES (V1, B1, etc.)
  let markers = "";
  state.voices.forEach((v, i) => {
      if (v.key === key) markers += `<g transform="translate(${tx - 25}, ${ty - 28}) scale(0.8)"><circle cx="10" cy="10" r="10" fill="var(--ok)"/><text x="10" y="11" text-anchor="middle" class="marker-text">V${i+1}</text></g>`;
  });
  state.insts.forEach((b, i) => {
      if (b.key === key) markers += `<g transform="translate(${tx + 5}, ${ty - 28}) scale(0.8)"><circle cx="10" cy="10" r="10" fill="var(--blue)"/><text x="10" y="11" text-anchor="middle" class="marker-text">B${i+1}</text></g>`;
  });
  
  return `<g onclick="updateField(state.mode, state.mode==='voz'?state.voices[0].id:state.insts[0].id, 'key', '${key}')">
    <path d="M ${x1} ${y1} A ${rout} ${rout} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${rin} ${rin} 0 0 0 ${x4} ${y4} Z" fill="${fill}" class="segment ${isA?'active-key':''} ${glowClass}"/>
    <g transform="rotate(15, ${tx}, ${ty})">
      <text x="${tx}" y="${ty-4}" text-anchor="middle" class="label-cam" style="fill:${isA?'#000':'#fff'}">${key}</text>
      <text x="${tx}" y="${ty+12}" text-anchor="middle" class="label-ang" style="fill:${isA?'#333':'rgba(255,255,255,0.6)'}">${DATA[key]}</text>
    </g>${markers}
  </g>`;
}

function setupDZ(id, inId, role) { const dz = document.querySelector(id); const input = document.getElementById(inId); if(!dz) return; dz.ondragover = (e) => { e.preventDefault(); dz.style.borderColor = "var(--ok)"; }; dz.ondragleave = () => dz.style.borderColor = "rgba(255,255,255,0.05)"; dz.ondrop = (e) => { e.preventDefault(); dz.style.borderColor = "rgba(255,255,255,0.05)"; handleFiles(e.dataTransfer.files, role); }; input.onchange = (e) => handleFiles(e.target.files, role); }

window.addEventListener('DOMContentLoaded', () => { 
  setupDZ('#colVoz .drop-zone', 'in_voz', 'voz'); 
  setupDZ('#colInst .drop-zone', 'in_inst', 'inst'); 
  render(); 
});
</script>
</body>
</html>

