<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>MashLab v1.1 - Studio</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#050508">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MashLab Studio">
<meta name="mobile-web-app-capable" content="yes">

<!-- Iconos PWA -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231f1f1f' width='100' height='100' rx='20'/><path d='M35 75V25l35-5v45M25 75a10 10 0 1 0 20 0 10 10 0 1 0-20 0M55 65a10 10 0 1 0 20 0 10 10 0 1 0-20 0' fill='none' stroke='%2300ff88' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231f1f1f' width='100' height='100' rx='20'/><path d='M35 75V25l35-5v45M25 75a10 10 0 1 0 20 0 10 10 0 1 0-20 0M55 65a10 10 0 1 0 20 0 10 10 0 1 0-20 0' fill='none' stroke='%2300ff88' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'/></svg>">

<style>
  :root {
    --bg-gradient: linear-gradient(135deg, #050508 0%, #0a0a15 50%, #050508 100%);
    --glass: rgba(10, 10, 20, 0.95);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text: #ffffff;
    --sub: #94a3b8;
    --ok: #00ff88;    
    --warn: #ffcc00;  
    --pitch: #00e5ff; 
    --blue: #3b82f6;
    --down: #ff3366;
    --accent: #ffffff;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
  
  body {
    margin: 0; padding: 0;
    min-height: 100vh;
    background: var(--bg-gradient);
    background-attachment: fixed;
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", sans-serif;
    overflow-x: hidden;
    overflow-y: auto;
    padding-top: env(safe-area-inset-top);
    padding-bottom: env(safe-area-inset-bottom);
  }

  .container { max-width: 1000px; margin: 0 auto; padding: 12px 12px 120px; }

  /* Navbar */
  .topbar {
    position: sticky; top: 0; z-index: 100;
    background: rgba(5, 5, 10, 0.9);
    backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
    border-bottom: 1px solid var(--glass-border);
  }
  .topbar-inner {
    display: flex; align-items: center; justify-content: space-between;
    height: 75px; max-width: 1000px; margin: 0 auto; padding: 0 16px;
  }
  .brand-logo { font-weight: 900; font-size: 20px; letter-spacing: -0.5px; }
  .mode-controls { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
  .mode-legend { font-size: 10px; color: var(--sub); font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; }

  /* Donaci√≥n */
  .donation-banner {
    background: linear-gradient(90deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid var(--glass-border);
    border-radius: 28px; padding: 20px; margin-bottom: 24px;
    display: flex; align-items: center; justify-content: space-between; gap: 15px;
    backdrop-filter: blur(15px);
  }
  @media(max-width: 650px) { .donation-banner { flex-direction: column; text-align: center; } }

  /* Paneles */
  .panel {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 28px; padding: 20px; margin-bottom: 24px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.7);
  }

  h2 { margin: 0; font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
  h3 { margin: 0 0 14px 0; font-size: 11px; color: var(--sub); text-transform: uppercase; letter-spacing: 2px; font-weight: 900; }

  .song-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }

  .song-item {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--glass-border);
    border-radius: 20px; padding: 14px;
    display: grid; grid-template-columns: 1fr 100px 40px; gap: 12px;
    align-items: center; margin-bottom: 12px;
  }

  .input, .select {
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid var(--glass-border);
    color: #fff; padding: 12px; border-radius: 14px;
    font-size: 14px; width: 100%;
  }

  /* Rueda Camelot */
  .wheel-wrapper {
    display: flex; flex-direction: column; align-items: center;
    background: rgba(0,0,0,0.5); border-radius: 40px; padding: 30px 20px;
    border: 1px solid var(--glass-border); margin-bottom: 24px;
    box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
  }
  
  .wheel-ring {
    width: 100%; max-width: 480px; aspect-ratio: 1/1;
    display: flex; align-items: center; justify-content: center;
    position: relative;
    background: radial-gradient(circle, rgba(255,255,255,0.02) 0%, transparent 75%);
    border-radius: 50%;
  }

  svg.camelot-wheel { width: 100%; height: 100%; transform: rotate(-15deg); }
  
  .segment-group { cursor: pointer; }
  .segment { transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); stroke: rgba(0,0,0,0.2); stroke-width: 0.5; }
  .segment-group:hover .segment { filter: brightness(1.2); }
  .segment.ghost { filter: drop-shadow(0 0 12px currentColor); opacity: 1; }
  .segment.active { stroke: #fff; stroke-width: 3px; }

  /* Resultados con Ne√≥n */
  .analysis-card {
    background: var(--glass);
    border-radius: 30px; padding: 24px; margin-bottom: 20px;
    border: 1px solid var(--glass-border);
  }
  .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(135px, 1fr)); gap: 12px; margin-top: 20px; }
  
  .opt-box {
    background: rgba(255, 255, 255, 0.02);
    padding: 14px; border-radius: 18px; border: 1px solid var(--glass-border);
    text-align: center; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }
  
  .opt-box.color-match { color: var(--ok); }
  .opt-box.color-energy { color: var(--warn); }
  .opt-box.color-pitchpro { color: var(--pitch); }

  .opt-box.selected { 
    border-color: currentColor; 
    background: rgba(255, 255, 255, 0.1); 
    transform: translateY(-4px); 
    box-shadow: 0 8px 25px rgba(0,0,0,0.5), 0 0 15px currentColor; 
  }

  /* Coach */
  .coach-panel {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid var(--glass-border);
    border-radius: 35px; padding: 24px; margin-top: 20px;
  }
  .coach-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
  .toggle-icon { font-size: 20px; transition: transform 0.3s; opacity: 0.6; }
  .coach-panel.closed .coach-body { display: none; }
  .coach-panel.closed .toggle-icon { transform: rotate(-90deg); }

  .coach-content { 
    background: rgba(0,0,0,0.4); border-radius: 24px; padding: 22px;
    border-left: 5px solid var(--ok); margin-top: 20px;
  }

  .dj-list {
    margin-top: 15px; padding: 15px; border-radius: 18px;
    background: rgba(255,255,255,0.02); font-size: 12px; color: var(--sub); line-height: 1.6;
    border: 1px solid var(--glass-border);
  }

  /* UI Elements */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 12px 20px; border-radius: 16px; border: 1px solid var(--glass-border);
    background: rgba(255, 255, 255, 0.05); color: var(--text);
    cursor: pointer; transition: 0.2s; font-weight: 700; font-size: 13px;
  }
  .btn.active { background: #fff; color: #000; border-color: #fff; box-shadow: 0 5px 15px rgba(255,255,255,0.2); }

  .marker-group, .label-group { pointer-events: none; }
  .marker-text { font-size: 10px; font-weight: 900; fill: #000; text-shadow: 0 0 2px rgba(255,255,255,0.5); }
  .label-cam { font-weight: 900; font-size: 15px; }
  .label-anglo { font-size: 11px; font-weight: 700; opacity: 0.8; }

  .footer { margin-top: 60px; text-align: center; border-top: 1px solid var(--glass-border); padding: 50px 16px 80px; }
</style>
</head>
<body>

  <div id="toast" style="position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 14px 28px; border-radius: 20px; font-weight: 800; opacity: 0; transition: 0.3s; z-index: 1000; pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">Copiado al Pitch</div>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand-logo">
        <span style="color:var(--ok)">MASH</span>LAB <span style="font-weight:200; opacity:0.6">STUDIO</span>
      </div>
      <div class="mode-controls">
        <div style="display:flex; gap:8px; background:rgba(255,255,255,0.05); padding:5px; border-radius:18px; border:1px solid var(--glass-border)">
          <button id="modeVoz" class="btn active" style="padding:8px 16px" onclick="setMode('voz')">Manda Voz</button>
          <button id="modeInst" class="btn" style="padding:8px 16px" onclick="setMode('inst')">Manda Base</button>
        </div>
        <div id="activeModeLegend" class="mode-legend">Seguir a la Voz</div>
      </div>
    </div>
  </div>

  <div class="container">
    
    <div class="donation-banner">
      <div style="display: flex; align-items: center; gap: 16px;">
        <span style="font-size: 32px;">üéß</span>
        <div style="text-align: left;">
          <div style="font-weight: 800; font-size: 16px; color: #fff;">Apoya a MashLab Studio</div>
          <div style="font-size: 12px; color: var(--sub); max-width: 400px;">Herramienta gratuita e independiente para la comunidad.</div>
        </div>
      </div>
      <div id="kofi-widget-container">
        <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
        <script type='text/javascript'>
          kofiwidget2.init('Inv√≠tame un Caf√©', '#72a4f2', 'U7U319RGKF');
          kofiwidget2.draw();
        </script>
      </div>
    </div>

    <div class="panel">
      <div class="song-grid">
        <div id="colVoz">
          <h3>Acapellas (Voces)</h3>
          <div id="listV"></div>
          <button class="btn" style="width:100%; border-style:dashed; margin-top:10px; background:transparent" onclick="addSong('voz')">‚ûï A√±adir Clip Voz</button>
        </div>
        <div id="colInst">
          <h3>Instrumentales (Bases)</h3>
          <div id="listI"></div>
          <button class="btn" style="width:100%; border-style:dashed; margin-top:10px; background:transparent" onclick="addSong('inst')">‚ûï A√±adir Clip Base</button>
        </div>
      </div>
    </div>

    <div class="wheel-wrapper">
      <div style="text-align:center; margin-bottom:20px">
        <h2 style="margin:0; text-transform:uppercase; letter-spacing:1px">Rueda de Camelot</h2>
        <p id="guideKeyLabel" style="color:var(--ok); font-size:18px; margin-top:8px; font-weight:900">--</p>
      </div>
      <div class="wheel-ring">
        <div id="wheelTarget" style="width:100%; height:100%;"></div>
      </div>
    </div>

    <div style="margin-bottom:20px; padding-left:10px">
      <h2 style="font-size:17px; color:var(--sub); margin-bottom: 20px;">Ajustes de Pitch Recomendados</h2>
      <div id="analysisContainer"></div>
    </div>

    <div id="coachPanel" class="coach-panel">
      <div class="coach-header" onclick="toggleCoach()">
        <h2>Monitor Arm√≥nico <small style="font-weight:400; opacity:0.6; font-size:13px; margin-left:10px">(Energ√≠a y Mood)</small></h2>
        <span class="toggle-icon">‚ñº</span>
      </div>
      <div class="coach-body">
        <div id="coachTabs" style="display:flex; gap:8px; flex-wrap:wrap; margin:20px 0;">
          <button id="tab-Exacta" class="btn active" onclick="setGlobalRelation('Exacta')">Match</button>
          <button id="tab-Relativa" class="btn" onclick="setGlobalRelation('Relativa')">Relativa</button>
          <button id="tab-Subida" class="btn" onclick="setGlobalRelation('Subida')">Subida</button>
          <button id="tab-Sutil" class="btn" onclick="setGlobalRelation('Sutil')">Sutil</button>
          <button id="tab-Energ√≠a" class="btn" onclick="setGlobalRelation('Energ√≠a')">Energ√≠a</button>
          <button id="tab-PitchPro" class="btn" onclick="setGlobalRelation('PitchPro')">Pitch Pro</button>
        </div>
        <div id="coachContent" class="coach-content"></div>
        <div id="djExperts" class="dj-list"></div>
        <p style="font-size: 13px; color: var(--sub); line-height: 1.6; padding: 0 10px; margin-top: 20px;">
          Estas son opciones creativas para tus mashups. Elige con libertad sabiendo que t√©cnicamente el mix ser√° arm√≥nico.
        </p>
      </div>
    </div>

    <footer class="footer">
      <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap; margin-bottom:30px">
        <a href="https://www.patreon.com/c/Ivanvazquezmx" target="_blank" style="text-decoration:none; color:#ff424d; font-weight:800">üíé Patreon</a>
        <a href="https://linktr.ee/ivanvazquezmusic" target="_blank" style="text-decoration:none; color:var(--ok); font-weight:800">üå≥ Linktree</a>
        <a href="https://www.instagram.com/ivanvazquezmx/" target="_blank" style="text-decoration:none; color:#fff; opacity:0.5">üì∏ Instagram</a>
      </div>
      <div style="font-size: 10px; opacity: 0.2; letter-spacing: 5px; font-weight:900">MASHLAB v1.1 ‚Ä¢ STUDIO</div>
    </footer>
  </div>

<script>
const DATA = {
  "1A":"G#m","2A":"Ebm","3A":"Bbm","4A":"Fm","5A":"Cm","6A":"Gm","7A":"Dm","8A":"Am","9A":"Em","10A":"Bm","11A":"F#m","12A":"Dbm",
  "1B":"B","2B":"F#","3B":"Db","4B":"Ab","5B":"Eb","6B":"Bb","7B":"F","8B":"C","9B":"G","10B":"D","11B":"A","12B":"E"
};
const PC = {
  "1A":8,"2A":3,"3A":10,"4A":5,"5A":0,"6A":7,"7A":2,"8A":9,"9A":4,"10A":11,"11A":6,"12A":1,
  "1B":11,"2B":6,"3B":1,"4B":8,"5B":3,"6B":10,"7B":5,"8B":0,"9B":7,"10B":2,"11B":9,"12B":4
};

const COACH_DATA = {
  'Exacta': { vibe: "Match Perfecto", desc: "Mezcla estable y limpia. El est√°ndar para transiciones invisibles y mashups largos.", color: "var(--ok)", djs: ["Tiesto", "Armin van Buuren", "Paul van Dyk", "Ferry Corsten", "John Digweed", "Hernan Cattaneo", "Sasha", "Above & Beyond", "Aly & Fila", "Markus Schulz"] },
  'Relativa': { vibe: "Cambio de Sentimiento", desc: "Mismas notas, diferente intenci√≥n. De euf√≥rico a reflexivo sin desafinar.", color: "var(--ok)", djs: ["Kaskade", "Deadmau5", "Eric Prydz", "ZHU", "Rufus Du Sol", "Lane 8", "Nora En Pure", "Gorgon City", "CamelPhat", "Ben B√∂hmer"] },
  'Subida': { vibe: "Energ√≠a en Ascenso (+1h)", desc: "Empuja el mix hacia adelante. Ideal para subir la intensidad del set de forma natural.", color: "var(--ok)", djs: ["David Guetta", "Calvin Harris", "Alesso", "Sebastian Ingrosso", "Steve Angello", "Martin Garrix", "Afrojack", "Dimitri Vegas", "Like Mike", "Nicky Romero"] },
  'Sutil': { vibe: "Mood Relajado (-1h)", desc: "Baja la intensidad con clase. Perfecto para sets progresivos y momentos m√°s profundos.", color: "var(--ok)", djs: ["Solomun", "Black Coffee", "Boris Brejcha", "Carl Cox", "Jamie Jones", "Marco Carola", "The Martinez Brothers", "Ricardo Villalobos", "Sven V√§th", "Adam Beyer"] },
  'Energ√≠a': { vibe: "Salto de Energ√≠a (+2h)", desc: "Inyecci√≥n de adrenalina pura. Prepara al p√∫blico para un drop explosivo.", color: "var(--warn)", djs: ["Skrillex", "Hardwell", "W&W", "Blasterjaxx", "Timmy Trumpet", "Steve Aoki", "Marshmello", "The Chainsmokers", "R3HAB", "Don Diablo"] },
  'PitchPro': { vibe: "Ajuste Inteligente (+/- 1st)", desc: "El secreto de los maestros. Tonalidades ricas que encajan perfectamente a solo un semitono.", color: "var(--pitch)", djs: ["Zedd", "James Hype", "Laidback Luke", "A-Trak", "Diplo", "Fred again..", "Four Tet", "Fisher", "Chris Lake", "Mochakk"] }
};

let state = JSON.parse(localStorage.getItem('mashlab_state')) || {
  mode: 'voz',
  selectedRel: 'Exacta',
  coachOpen: true,
  voices: [{id:1, title:'Acapella principal', key:'4B'}],
  insts: [{id:101, title:'Beat instrumental', key:'6A'}],
};

function save() { localStorage.setItem('mashlab_state', JSON.stringify(state)); }

function toggleCoach() {
  state.coachOpen = !state.coachOpen;
  document.getElementById('coachPanel').classList.toggle('closed', !state.coachOpen);
  save();
}

function getShift(from, to) {
  let diff = (PC[to] - PC[from] + 12) % 12;
  return diff > 6 ? diff - 12 : diff;
}

function getTargetKey(guideKey, type) {
  const n = parseInt(guideKey), m = guideKey.slice(-1);
  if (type === 'Exacta') return guideKey;
  if (type === 'Relativa') return `${n}${m === 'A' ? 'B' : 'A'}`;
  if (type === 'Subida') return `${n === 12 ? 1 : n + 1}${m}`;
  if (type === 'Sutil') return `${n === 1 ? 12 : n - 1}${m}`;
  if (type === 'Energ√≠a') return `${n + 2 > 12 ? (n + 2) - 12 : n + 2}${m}`;
  if (type === 'PitchPro') {
    let p = null, mi = null;
    for (let k in DATA) {
      if (k === guideKey || k.slice(-1) !== m) continue;
      const s = getShift(guideKey, k);
      if (s === 1) p = k; if (s === -1) mi = k;
    }
    return p || mi || guideKey;
  }
  return guideKey;
}

function updateCoachUI(type) {
  const container = document.getElementById('coachContent');
  const djsContainer = document.getElementById('djExperts');
  if (!container || !djsContainer) return;
  const info = COACH_DATA[type];
  document.querySelectorAll('#coachTabs .btn').forEach(b => b.classList.toggle('active', b.id === `tab-${type}`));
  container.style.borderLeftColor = info.color;
  container.innerHTML = `<div style="font-weight:900; font-size:16px; margin-bottom:10px; color:${info.color}">${info.vibe}</div><div style="font-size:14px; line-height:1.6;">${info.desc}</div>`;
  djsContainer.innerHTML = `<strong>Esta t√©cnica la ocupan mucho estos DJs:</strong><br>${info.djs.join(", ")}.`;
}

function setGlobalRelation(type) {
  state.selectedRel = type;
  updateCoachUI(type);
  render();
}

function render() {
  const list = state.mode === 'voz' ? state.voices : state.insts;
  const guideKey = list.length ? list[0].key : "1A";
  document.getElementById('guideKeyLabel').textContent = `${guideKey} (${DATA[guideKey]})`;
  document.getElementById('activeModeLegend').textContent = state.mode === 'voz' ? 'Seguir a la Voz' : 'Seguir a la Base';
  
  renderList('voz', state.voices);
  renderList('inst', state.insts);
  renderAnalysis(guideKey);
  drawWheel(guideKey);
  save();
}

function renderList(type, songs) {
  const container = document.getElementById(type === 'voz' ? 'listV' : 'listI');
  container.innerHTML = '';
  songs.forEach((s, idx) => {
    const isG = state.mode === type && idx === 0;
    const div = document.createElement('div');
    div.className = `song-item ${isG ? 'is-guide' : ''}`;
    div.innerHTML = `
      <input type="text" class="input" value="${s.title}" onchange="updateSong('${type}',${s.id},'title',this.value)">
      <select class="select" onchange="updateSong('${type}',${s.id},'key',this.value)">
        ${Object.keys(DATA).map(k => `<option value="${k}" ${k===s.key?'selected':''}>${k} (${DATA[k]})</option>`).join('')}
      </select>
      <button onclick="deleteSong('${type}',${s.id})" style="background:none; border:none; color:var(--down); font-weight:800; cursor:pointer">‚úï</button>
    `;
    container.appendChild(div);
  });
}

function renderAnalysis(guideKey) {
  const container = document.getElementById('analysisContainer');
  const targets = state.mode === 'voz' ? state.insts : state.voices;
  if (!targets.length) { container.innerHTML = ""; return; }
  container.innerHTML = targets.map(song => {
    const tk = getTargetKey(guideKey, state.selectedRel);
    const sh = getShift(song.key, tk);
    const isSel = state.selectedRel;
    const cat = ['Exacta','Relativa','Subida','Sutil'].includes(isSel) ? 'match' : (isSel==='Energ√≠a'?'energy':'pitchpro');
    
    return `<div class="analysis-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
          <div><div style="font-weight:800; font-size:18px">${song.title}</div><div style="font-size:12px; color:var(--sub)">Original: ${song.key}</div></div>
          <div style="text-align:right">
             <div style="font-size:10px; color:var(--sub); margin-bottom:4px">KEY SHIFT</div>
             <div style="font-size:20px; font-weight:900; color:${sh === 0 ? 'var(--ok)' : (sh > 0 ? 'var(--warn)' : 'var(--down)')}">${sh === 0 ? '0' : (sh > 0 ? '+'+sh : sh)} st</div>
          </div>
        </div>
        <div class="options-grid">
          ${['Exacta','Relativa','Subida','Sutil','Energ√≠a','PitchPro'].map(type => {
            const k = getTargetKey(guideKey, type);
            const sVal = getShift(song.key, k);
            const isSelected = state.selectedRel === type;
            const tCat = ['Exacta','Relativa','Subida','Sutil'].includes(type) ? 'match' : (type==='Energ√≠a'?'energy':'pitchpro');
            
            return `<div class="opt-box ${isSelected ? 'selected' : ''} color-${tCat}" onclick="setGlobalRelation('${type}')">
              <div style="font-size:9px; font-weight:900; opacity:0.6; text-transform:uppercase">${type}</div>
              <div style="font-weight:900; font-size:14px">${k}</div>
              <div style="font-size:12px; font-weight:800; opacity:0.8">${sVal === 0 ? '0' : (sVal > 0 ? '+' + sVal : sVal)} st</div>
            </div>`;
          }).join('')}
        </div>
      </div>`;
  }).join('');
}

function drawWheel(guideKey) {
  const target = document.getElementById('wheelTarget');
  const size = 500, cx = 250, cy = 250, rO = 235, rM = 155, rIn = 85;
  let html = `<svg viewBox="0 0 ${size} ${size}" class="camelot-wheel">`;
  for(let i=0; i<12; i++) {
    const s = (i * 30) - 15, e = ((i + 1) * 30) - 15;
    html += drawSeg(cx, cy, rM, rO, s, e, `${i+1}B`, guideKey);
    html += drawSeg(cx, cy, rIn, rM, s, e, `${i+1}A`, guideKey);
  }
  target.innerHTML = html + `</svg>`;
}

function drawSeg(cx, cy, rin, rout, s, e, key, guide) {
  const rad = Math.PI / 180;
  const x1 = cx + rout * Math.cos(s * rad), y1 = cy + rout * Math.sin(s * rad);
  const x2 = cx + rout * Math.cos(e * rad), y2 = cy + rout * Math.sin(e * rad);
  const x3 = cx + rin * Math.cos(e * rad), y3 = cy + rin * Math.sin(e * rad);
  const x4 = cx + rin * Math.cos(s * rad), y4 = cy + rin * Math.sin(s * rad);
  
  const isA = key === guide;
  const currentTarget = getTargetKey(guide, state.selectedRel);
  const isGhost = key === currentTarget && !isA;
  const tk = ['Exacta','Relativa','Subida','Sutil','Energ√≠a','PitchPro'].map(t => getTargetKey(guide, t));
  const isCompatible = tk.includes(key);
  
  let fill = "rgba(255,255,255,0.02)";
  if (isA) fill = "#fff";
  else if (isGhost) {
    const type = state.selectedRel;
    if(['Exacta','Relativa','Subida','Sutil'].includes(type)) fill = "var(--ok)";
    else if(type==='Energ√≠a') fill = "var(--warn)";
    else fill = "var(--pitch)";
  } 
  else if (isCompatible) {
    const type = ['Exacta','Relativa','Subida','Sutil','Energ√≠a','PitchPro'].find(t => getTargetKey(guide, t) === key);
    if(['Exacta','Relativa','Subida','Sutil'].includes(type)) fill = "rgba(0, 255, 136, 0.2)";
    else if(type==='Energ√≠a') fill = "rgba(255, 204, 0, 0.2)";
    else fill = "rgba(0, 229, 255, 0.2)";
  }

  const mid = (s + e) / 2, tx = cx + ((rin + rout) / 2) * Math.cos(mid * rad), ty = cy + ((rin + rout) / 2) * Math.sin(mid * rad);
  const vP = state.voices.find(v => v.key === key), bP = state.insts.find(i => i.key === key);
  
  let m = ""; 
  if(vP) m += `<circle cx="${tx-14}" cy="${ty-16}" r="10" fill="var(--ok)"/><text x="${tx-14}" y="${ty-12.5}" text-anchor="middle" class="marker-text">V</text>`;
  if(bP) m += `<circle cx="${tx+14}" cy="${ty-16}" r="10" fill="var(--blue)"/><text x="${tx+14}" y="${ty-12.5}" text-anchor="middle" class="marker-text">B</text>`;
  
  return `<g class="segment-group" onclick="setKeyFromWheel('${key}')">
    <path d="M ${x1} ${y1} A ${rout} ${rout} 0 0 1 ${x2} ${y2} L ${x3} ${y3} A ${rin} ${rin} 0 0 0 ${x4} ${y4} Z" fill="${fill}" class="segment ${isGhost?'ghost':''} ${isA?'active':''}" />
    <g class="label-group"><text x="${tx}" y="${ty+4}" text-anchor="middle" class="label-cam" style="fill:${isA?'#000':'#fff'}">${key}</text><text x="${tx}" y="${ty+18}" text-anchor="middle" class="label-anglo" style="fill:${isA?'#333':'rgba(255,255,255,0.6)'}">${DATA[key]}</text></g>
    <g class="marker-group">${m}</g>
  </g>`;
}

function setKeyFromWheel(key) { const list = state.mode==='voz'?state.voices:state.insts; if(list.length) updateSong(state.mode, list[0].id, 'key', key); }
function setMode(m) { state.mode = m; document.getElementById('modeVoz').classList.add('active'); document.getElementById('modeInst').classList.remove('active'); if(m==='inst'){ document.getElementById('modeInst').classList.add('active'); document.getElementById('modeVoz').classList.remove('active'); } render(); }
function addSong(t) { const id = Date.now(), s = { id, title: `Pista ${t==='voz'?'Voz':'Inst'}`, key: '8A' }; if(t==='voz') state.voices.push(s); else state.insts.push(s); render(); }
function deleteSong(t, id) { const arr = t==='voz' ? state.voices : state.insts; if(arr.length > 1) { if(t==='voz') state.voices = state.voices.filter(x=>x.id!==id); else state.insts = state.insts.filter(x=>x.id!==id); render(); } }
function updateSong(t, id, f, v) { const arr = t==='voz' ? state.voices : state.insts; const s = arr.find(x=>x.id===id); if(s) { s[f] = v; render(); } }
function copyToClipboard(t) { const el = document.createElement('textarea'); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); const toast = document.getElementById('toast'); toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000); }

window.onload = () => {
  render();
  updateCoachUI(state.selectedRel);
  document.getElementById('coachPanel').classList.toggle('closed', !state.coachOpen);
};
</script>
</body>
</html>
